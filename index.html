<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>GIF Galleries (fast tabs + cache)</title>
<link rel="preconnect" href="https://api.github.com">
<style>
  html,body{overscroll-behavior-y:none}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR','Malgun Gothic',Helvetica,Arial,sans-serif;margin:0}
  #amg{max-width:1000px;margin:24px auto;padding:16px}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;justify-content:center}
  .tab{border:1px solid #ddd;background:#fafafa;border-radius:999px;padding:8px 14px;cursor:pointer;user-select:none}
  .tab.active{background:#1d4ed8;color:#fff;border-color:#1d4ed8}
  .stage{position:relative;border:1px solid #eee;height:450px;border-radius:12px;padding:12px;display:flex;align-items:center;justify-content:center;text-align:center}
  #amg_main{max-width:100%;max-height:100%;width:auto;height:auto;display:inline-block;border-radius:8px;pointer-events:none;object-fit:contain}
  .nav{position:absolute;top:50%;transform:translateY(-50%);width:40px;height:40px;border-radius:999px;border:0;background:rgba(0,0,0,.45);color:#fff;font-size:20px;cursor:pointer;z-index:10;display:flex;align-items:center;justify-content:center}
  #amg_prev{left:8px} #amg_next{right:8px}
  #amg_strip{margin-top:10px;display:flex;gap:10px;overflow-x:auto;-webkit-overflow-scrolling:touch;padding:6px 2px;overscroll-behavior:contain;touch-action:pan-x;scrollbar-gutter:stable both-edges}
  .amg_th{flex:0 0 calc((100% - 7*10px)/8);border:2px solid #ddd;border-radius:8px;padding:0;background:#fff;cursor:pointer;outline:none}
  .amg_th img{display:block;width:100%;height:100px;object-fit:cover;border-radius:6px;pointer-events:none}
  .amg_th.active{border-color:#7aa7ff}
  .empty{color:#888;text-align:center;padding:20px 0}
  .sentinel{flex:0 0 1px;width:1px;height:1px}
#amg_main,
#amg_strip img {
  -webkit-user-drag: none;
  user-drag: none;
  -webkit-touch-callout: none; /* iOS ê¸¸ê²Œ ëˆ„ë¥´ê¸° ë©”ë‰´ ë§‰ê¸° */
  user-select: none;
}

</style>
</head>
<body>
<div id="amg" oncontextmenu="return false">
  <div class="tabs" id="tabs"></div>

  <div class="stage">
    <img id="amg_main" alt="ë¯¸ë¦¬ë³´ê¸°" fetchpriority="high" decoding="async">
    <button id="amg_prev" class="nav" type="button" aria-label="ì´ì „">â€¹</button>
    <button id="amg_next" class="nav" type="button" aria-label="ë‹¤ìŒ">â€º</button>
  </div>

  <div id="amg_strip"></div>
  <!-- ğŸ‘ï¸ ì˜¤ëŠ˜ ì¡°íšŒìˆ˜(ë§¤ì¼ 0ì‹œ KST ë¦¬ì…‹) -->
<div class="pvbar" aria-label="ì˜¤ëŠ˜ ì¡°íšŒìˆ˜" style="display:flex;justify-content:flex-end;margin-top:6px;opacity:.65">
  <span style="font:12px/1.2 system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR','Malgun Gothic',sans-serif">
    HIT: <b id="page-views">â€”</b>
  </span>
</div>

</div>

<script>
(() => {
  // íƒ­/í´ë”
  const GALLERIES = [
    { label:'A-1íƒ€ì…', dir:'A-1images' },
    { label:'A-2íƒ€ì…', dir:'A-2images' },
    { label:'Bíƒ€ì…',   dir:'Bimages'   }
  ];
  const OWNER='Objectivity1', REPO='artmug_obee', BRANCH='main';

  // íŠœë‹ íŒŒë¼ë¯¸í„°
  const MAX_PER_DIR = 60;
  const BATCH = 8;               // ì´ˆê¸°/ì¶”ê°€ ì¸ë„¤ì¼ ê°œìˆ˜ â†’ ì‘ì„ìˆ˜ë¡ ì´ˆê¸° ë ‰â†“
  const PREFETCH_NEIGHBOR = 1;   // ë©”ì¸ ì–‘ì˜† í”„ë¦¬ë¡œë“œ ê°œìˆ˜(1 ì¶”ì²œ)

  // DOM
  const tabsEl=document.getElementById('tabs');
  const main=document.getElementById('amg_main');
  const prev=document.getElementById('amg_prev');
  const next=document.getElementById('amg_next');
  const strip=document.getElementById('amg_strip');

  // ìºì‹œ (ë©”ëª¨ë¦¬ + localStorage)
  const memCache=new Map(); // dir -> { list, etag, time }
  const LS_KEY='amg_manifest_v1';

  function loadLS(){
    try{ return JSON.parse(localStorage.getItem(LS_KEY)||'{}'); }catch{ return {}; }
  }
  function saveLS(obj){
    try{ localStorage.setItem(LS_KEY, JSON.stringify(obj)); }catch{}
  }

  function numKey(name){
    const m = name.match(/(\d+)/);
    return m ? parseInt(m[1],10) : Number.POSITIVE_INFINITY;
  }

  async function listViaGithubAPI(dir){
    const url=`https://api.github.com/repos/${OWNER}/${REPO}/contents/${encodeURIComponent(dir)}?ref=${encodeURIComponent(BRANCH)}`;
    const res=await fetch(url, {headers:{'Accept':'application/vnd.github+json'}});
    if(!res.ok) throw new Error('api_fail_'+res.status);
    const etag = res.headers.get('etag') || '';
    const data=await res.json();
    const list=data.filter(it=>it.type==='file' && /\.gif$/i.test(it.name))
                   .sort((a,b)=> numKey(a.name)-numKey(b.name))
                   .slice(0,MAX_PER_DIR)
                   .map(it=>`${dir}/${it.name}`);
    return { list, etag };
  }

  async function listByProbe(dir, maxTry=MAX_PER_DIR){
    const out=[];
    // ì „ìˆ˜ê²€ì‚¬(ì¡°ê¸° ì¢…ë£Œ ì—†ìŒ): ìºì‹œ ë¯¸ìŠ¤ì¼ ë•Œë„ ëŠë¦¬ì§€ ì•Šë„ë¡ HEADëŠ” ë³‘ë ¬ Nê°œë¡œ ì œí•œ
    const CONC=8;
    let i=1;
    async function worker(){
      while(i<=maxTry){
        const n=i++;
        const p=`${dir}/${n}.gif`;
        try{
          const r=await fetch(p,{method:'HEAD', cache:'no-cache'});
          if(r.ok) out.push(p);
        }catch(_){}
      }
    }
    await Promise.all(Array.from({length:CONC}, worker));
    return out;
  }

  async function getImages(dir){
    // 1) ë©”ëª¨ë¦¬ ìºì‹œ
    if(memCache.has(dir)) return memCache.get(dir).list;

    // 2) localStorage ìºì‹œ ìš°ì„  ì‚¬ìš© â†’ ì¦‰ì‹œ í‘œì‹œ â†’ ë°±ê·¸ë¼ìš´ë“œ ìµœì‹ í™”
    const ls = loadLS();
    const entry = ls[dir];
    if(entry && Array.isArray(entry.list) && entry.list.length){
      // ë°±ê·¸ë¼ìš´ë“œ ìµœì‹ í™”(ì‹¤íŒ¨í•´ë„ ë¬´ì‹œ)
      refreshInBG(dir, entry.etag).catch(()=>{});
      memCache.set(dir, { list: entry.list, etag: entry.etag, time: Date.now() });
      return entry.list;
    }

    // 3) API ì‹œë„
    try{
      const { list, etag } = await listViaGithubAPI(dir);
      if(list.length){
        memCache.set(dir,{list,etag,time:Date.now()});
        ls[dir]={list,etag}; saveLS(ls);
        return list;
      }
      // APIê°€ ë¦¬ìŠ¤íŠ¸ 0ê°œë©´ í´ë°±
      const fb = await listByProbe(dir);
      memCache.set(dir,{list:fb,etag:'',time:Date.now()});
      ls[dir]={list:fb,etag:''}; saveLS(ls);
      return fb;
    }catch(_){
      // API ì‹¤íŒ¨ â†’ í´ë°±
      const fb = await listByProbe(dir);
      memCache.set(dir,{list:fb,etag:'',time:Date.now()});
      const ls2=loadLS(); ls2[dir]={list:fb,etag:''}; saveLS(ls2);
      return fb;
    }
  }

  async function refreshInBG(dir, oldEtag){
    try{
      const { list, etag } = await listViaGithubAPI(dir);
      if(!oldEtag || etag !== oldEtag){
        memCache.set(dir,{list,etag,time:Date.now()});
        const ls = loadLS(); ls[dir]={list,etag}; saveLS(ls);
        // í™”ë©´ì— ê·¸ ë””ë ‰í† ë¦¬ ì—´ë ¤ìˆë‹¤ë©´ ìµœì‹ í™”
        if(current && current.dir===dir) renderGallery(list, /*keepIndex=*/true);
      }
    }catch(_){}
  }

  // === ì¸ë„¤ì¼ ë Œë” ===
  const ph='data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';
  const thumbIO='IntersectionObserver' in window ? new IntersectionObserver(entries=>{
    for(const e of entries){
      if(e.isIntersecting){
        const img=e.target;
        if(img.dataset.src){ img.src=img.dataset.src; img.removeAttribute('data-src'); }
        thumbIO.unobserve(img);
      }
    }
  }, {root:strip, rootMargin:'200px 0px', threshold:0.01}) : null;

  let imgs=[], shown=0, ths=[], idx=0;
  let isLoadingBatch=false;

  function ensureThumbVisible(k){
    const t=ths[k]; if(!t) return;
    const tRect=t.getBoundingClientRect(), sRect=strip.getBoundingClientRect();
    if(tRect.left < sRect.left){ strip.scrollLeft += (tRect.left - sRect.left) - 10; }
    if(tRect.right> sRect.right){ strip.scrollLeft += (tRect.right- sRect.right)+ 10; }
  }

  function preloadNeighbor(center){
    for(let d=1; d<=PREFETCH_NEIGHBOR; d++){
      const ns=[center-d, center+d];
      ns.forEach(n=>{
        if(n<0||n>=imgs.length) return;
        const url=imgs[n];
        const im=new Image(); im.decoding='async'; im.loading='eager'; im.src=url;
      });
    }
  }

  function highlight(){ ths.forEach((el,k)=>el.classList.toggle('active',k===idx)); }

  function show(i){
    if(!imgs.length) return;
    idx=(i+imgs.length)%imgs.length;
    const src=imgs[idx];
    if(main.src!==src) main.src=src;
    highlight(); ensureThumbVisible(idx); preloadNeighbor(idx);
    // ì•„ì§ ê·¸ë ¤ì§€ì§€ ì•Šì€ ë ê·¼ì²˜ë©´ ë‹¤ìŒ ë°°ì¹˜ ë¯¸ë¦¬ ë¶™ì„
    if(idx >= shown-1) appendBatch();
  }

  function appendBatch(){
  if(isLoadingBatch || shown>=imgs.length) return;
  isLoadingBatch=true;
  const end=Math.min(shown+BATCH, imgs.length);
  const frag=document.createDocumentFragment();
  for(let i=shown;i<end;i++){
    const src=imgs[i]; // GIF ê²½ë¡œ
    const btn=document.createElement('button');
    btn.className='amg_th'; btn.dataset.idx=i; btn.type='button';
    btn.addEventListener('mousedown',e=>e.preventDefault());
    btn.onclick=()=>show(i);

    const im=document.createElement('img');
    im.alt=`ì¸ë„¤ì¼ ${i+1}`;
    im.loading='lazy';
    im.decoding='async';

    // PNG ìš°ì„ : images â†’ thumbs, í™•ì¥ì .gif â†’ .png
    const thumb = src.replace('images','thumbs').replace(/\.gif$/i, '.png');
    im.src = thumb;
    // PNG ì—†ìœ¼ë©´ GIFë¡œ í´ë°±
    im.onerror = () => { im.src = src; };

    btn.appendChild(im);
    frag.appendChild(btn);
    ths.push(btn);
  }
  strip.appendChild(frag);
  shown=end;
  isLoadingBatch=false;
}


  function renderGallery(list, keepIndex=false){
    imgs=list; shown=0; ths=[]; if(!keepIndex) idx=0;
    strip.innerHTML='';
    if(!imgs.length){
      strip.innerHTML='<div class="empty">ì´ë¯¸ì§€ ì—†ìŒ</div>';
      main.removeAttribute('src'); prev.style.display=next.style.display='none';
      return;
    }
    prev.style.display=next.style.display='';
    appendBatch();
    show(keepIndex ? idx : 0);
  }

  // ê°€ë¡œ ìŠ¤í¬ë¡¤ ë ê·¼ì²˜ë©´ ìë™ ì¶”ê°€
  strip.addEventListener('scroll', ()=>{
    if(shown>=imgs.length || isLoadingBatch) return;
    const nearEnd = strip.scrollLeft + strip.clientWidth >= strip.scrollWidth - 80;
    if(nearEnd) appendBatch();
  }, {passive:true});

  prev.onclick=()=>show(idx-1);
  next.onclick=()=>show(idx+1);

  // ìŠ¤ì™€ì´í”„
  let startX=null;
  main.addEventListener('touchstart',e=>{ startX=e.touches[0].clientX; },{passive:true});
  main.addEventListener('touchend',e=>{
    if(startX===null) return;
    const dx=e.changedTouches[0].clientX-startX;
    if(Math.abs(dx)>40) show(idx+(dx<0?1:-1));
    startX=null;
  },{passive:true});

  // íƒ­ ì „í™˜
  let current=null; // {label, dir, el}
  async function activateTab(tab){
    if(current?.dir===tab.dir){
      // ê°™ì€ íƒ­ ë‹¤ì‹œ ëˆ„ë¥´ë©´ ì¦‰ì‹œ ìºì‹œ í‘œì‹œ
      const cached = memCache.get(tab.dir)?.list || loadLS()[tab.dir]?.list || [];
      if(cached.length) renderGallery(cached, /*keepIndex=*/true);
      return;
    }
    tabsEl.querySelectorAll('.tab').forEach(el=>el.classList.remove('active'));
    tab.el.classList.add('active');
    current=tab;

    // 1) ìºì‹œ ì¦‰ì‹œ ì‚¬ìš©
    const first = memCache.get(tab.dir)?.list || loadLS()[tab.dir]?.list || [];
    if(first.length) renderGallery(first);

    // 2) ìµœì‹  ëª©ë¡ í™•ë³´ (APIâ†’í´ë°±)
    const list = await getImages(tab.dir);
    renderGallery(list);

    // 3) ë‹¤ìŒ/ì´ì „ íƒ­ ì›Œë°ì—…(ì²« ì´ë¯¸ì§€ 1ì¥ë§Œ)
    warmNeighbors(tab);
  }

  // ë‹¤ìŒ/ì´ì „ íƒ­ ì‚¬ì „ í”„ë¦¬í˜ì¹˜
  function warmNeighbors(tab){
    const idxTab = GALLERIES.findIndex(g=>g.dir===tab.dir);
    [idxTab-1, idxTab+1].forEach(async ti=>{
      if(ti<0 || ti>=GALLERIES.length) return;
      const t = GALLERIES[ti];
      // ì´ë¯¸ ìºì‹œë¼ ìˆìœ¼ë©´ ìŠ¤í‚µ
      if(memCache.has(t.dir)) return;
      // ëª©ë¡ë§Œ ë¹ ë¥´ê²Œ ê°€ì ¸ì˜¤ê³  ì²« 1ì¥ë§Œ ì˜ˆì—´
      const list = await getImages(t.dir);
      if(list && list[0]){
        const im = new Image();
        im.decoding='async'; im.loading='eager'; im.src=list[0];
      }
    });
  }

  // íƒ­ ë²„íŠ¼ ìƒì„±
  GALLERIES.forEach(g=>{
    const btn=document.createElement('div');
    btn.className='tab'; btn.textContent=g.label;
    btn.onclick=()=>activateTab({...g, el:btn});
    g.el=btn; tabsEl.appendChild(btn);
  });

  // ì²« íƒ­
  activateTab({...GALLERIES[0], el:tabsEl.firstChild});
})();
  // ê°¤ëŸ¬ë¦¬ ì´ë¯¸ì§€ ìš°í´ë¦­ ë°©ì§€
document.addEventListener('DOMContentLoaded', ()=>{
  document.querySelectorAll('#amg_main, #amg_strip img').forEach(img=>{
    img.addEventListener('contextmenu', e=> e.preventDefault());
  });
});
// ìš°í´ë¦­/ë“œë˜ê·¸ ì „ì—­ ìœ„ì„ (ì»¨í…Œì´ë„ˆ ê¸°ì¤€ìœ¼ë¡œ ëª¨ë‘ ì°¨ë‹¨)
document.addEventListener('contextmenu', (e) => {
  const t = e.target;
  if (t && (t.closest('.stage') || t.closest('#amg_strip'))) {
    e.preventDefault();
  }
}, true); // ìº¡ì²˜ ë‹¨ê³„ì—ì„œ ì„ ì°¨ë‹¨

document.addEventListener('dragstart', (e) => {
  const t = e.target;
  if (t && (t.closest('.stage') || t.closest('#amg_strip'))) {
    e.preventDefault();
  }
}, true);


</script>

  <script>
(async () => {
  // ë„¤ì„ìŠ¤í˜ì´ìŠ¤ëŠ” í”„ë¡œì íŠ¸ ê³ ìœ ê°’ìœ¼ë¡œ ìœ ì§€
  const NAMESPACE = 'objectivity1.github.io_artmug_obee';

  // í•œêµ­ ì‹œê°„(Asia/Seoul) ê¸°ì¤€ YYYYMMDD ë§Œë“¤ê¸°
  function kstDateKey() {
    const parts = new Intl.DateTimeFormat('ko-KR', {
      timeZone: 'Asia/Seoul',
      year: 'numeric', month: '2-digit', day: '2-digit'
    }).formatToParts(new Date());
    const y = parts.find(p => p.type === 'year').value;
    const m = parts.find(p => p.type === 'month').value;
    const d = parts.find(p => p.type === 'day').value;
    return y + m + d; // e.g., 20250920
  }

  // í˜ì´ì§€ ì‹ë³„ì(ì›í•˜ë©´ location.pathname ì¨ì„œ í˜ì´ì§€ë³„ ë¶„ë¦¬ ê°€ëŠ¥)
  const PAGE_ID = 'index';
  const DAILY_KEY = encodeURIComponent(`${PAGE_ID}_${kstDateKey()}`);

  // ì˜¤ëŠ˜ì í‚¤ë¡œ ì¹´ìš´íŠ¸
  const url = `https://api.countapi.xyz/hit/${NAMESPACE}/${DAILY_KEY}`;

  try {
    const res = await fetch(url, { cache: 'no-store' });
    const data = await res.json();
    const el = document.getElementById('page-views');
    if (el && typeof data.value === 'number') {
      el.textContent = data.value.toLocaleString('ko-KR');
    }
  } catch {
    const el = document.getElementById('page-views');
    if (el) el.textContent = 'â€”';
  }
})();
</script>

</body>
</html>
