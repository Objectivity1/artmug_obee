<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>GIF Gallery (auto)</title>
  <style>
    html, body { overscroll-behavior-y: none; }
    #amg { border:1px solid #eee; border-radius:12px; padding:12px;
      max-width: 520px; margin: 0 auto;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans KR', 'Malgun Gothic', Helvetica, Arial, sans-serif; }
    #amg .stage { position:relative; border:1px solid #eee; border-radius:12px; padding:12px; text-align:center; }
    #amg #amg_main { width:450px; max-width:100%; display:inline-block; border-radius:8px; pointer-events:none; }
    #amg .nav { position:absolute; top:50%; transform:translateY(-50%);
      width:40px; height:40px; border-radius:999px; border:0; background:rgba(0,0,0,.45);
      color:#fff; font-size:20px; cursor:pointer; z-index:10; display:flex; align-items:center; justify-content:center; }
    #amg #amg_prev { left:8px; }  #amg #amg_next { right:8px; }
    #amg #amg_strip { margin-top:10px; display:flex; gap:10px; overflow-x:auto; -webkit-overflow-scrolling:touch; padding:6px 2px;
      overscroll-behavior: contain; touch-action: pan-x; scrollbar-gutter: stable both-edges; }
    #amg .amg_th { flex: 0 0 calc((100% - 7*10px)/8); border:2px solid #ddd; border-radius:8px; padding:0; background:#fff; cursor:pointer; outline: none; }
    #amg .amg_th img { display:block; width:100%; height:100px; object-fit:cover; border-radius:6px; pointer-events:none; }
    #amg .amg_th.active { border-color:#7aa7ff; }
    #amg .empty { text-align:center; color:#888; padding:24px 0; }
  </style>
</head>
<body>
  <div id="amg">
    <div class="stage">
      <img id="amg_main" alt="미리보기">
      <button id="amg_prev" class="nav" type="button" aria-label="이전">‹</button>
      <button id="amg_next" class="nav" type="button" aria-label="다음">›</button>
    </div>
    <div id="amg_strip"></div>
  </div>

  <script>
  (async function(){
    // ▼ 여기만 필요시 수정
    const OWNER   = 'Objectivity1';
    const REPO    = 'artmug_obee';
    const BRANCH  = 'main';
    const IMG_DIR = 'A-1images'; // 예: 'A-1images'
    // ▲

    const root  = document.getElementById('amg');
    const main  = root.querySelector('#amg_main');
    const prev  = root.querySelector('#amg_prev');
    const next  = root.querySelector('#amg_next');
    const strip = root.querySelector('#amg_strip');

    // 숫자 정렬용
    const numKey = (name) => {
      const m = name.match(/^(\d+)\.gif$/i);
      return m ? parseInt(m[1], 10) : Number.POSITIVE_INFINITY;
    };

    async function listViaGithubAPI(){
      const url = `https://api.github.com/repos/${OWNER}/${REPO}/contents/${encodeURIComponent(IMG_DIR)}?ref=${encodeURIComponent(BRANCH)}`;
      const res = await fetch(url, {headers:{'Accept':'application/vnd.github+json'}});
      if(!res.ok) throw new Error('api_fail_'+res.status);
      const data = await res.json();
      return data
        .filter(it => it.type === 'file' && /\.gif$/i.test(it.name))
        .sort((a,b)=> numKey(a.name) - numKey(b.name))
        .map(it => `${IMG_DIR}/${it.name}`); // 사이트 상대경로로 사용
    }

    async function listByProbing(maxTry=500){
      // 1.gif부터 maxTry까지 HEAD로 존재 확인, 5번 연속 실패하면 중단
      const out = [];
      let misses = 0;
      for(let i=1; i<=maxTry; i++){
        const p = `${IMG_DIR}/${i}.gif`;
        try{
          const r = await fetch(p, {method:'HEAD', cache:'no-cache'});
          if(r.ok){ out.push(p); misses = 0; }
          else { misses++; }
        }catch(_){ misses++; }
        if(misses >= 5 && out.length>0) break;
      }
      if(!out.length) throw new Error('probe_empty');
      return out;
    }

    async function getImages(){
      try{
        return await listViaGithubAPI();
      }catch(e){
        // API 막히면 폴백
        console.warn('Github API 실패, probing으로 폴백:', e);
        return await listByProbing(999);
      }
    }

    function buildUI(imgs){
      if(!imgs.length){
        strip.innerHTML = '<div class="empty">표시할 GIF가 없음</div>';
        main.remove();
        prev.style.display = next.style.display = 'none';
        return;
      }

      // 썸네일 버튼 생성
      strip.innerHTML = '';
      imgs.forEach((src, i)=>{
        const btn = document.createElement('button');
        btn.className = 'amg_th';
        btn.dataset.src = src;
        const img = document.createElement('img');
        img.src = src;
        img.alt = `썸네일 ${i+1}`;
        btn.appendChild(img);
        strip.appendChild(btn);
      });

      const ths = Array.from(strip.querySelectorAll('.amg_th'));
      let idx = 0;

      function highlight(){ ths.forEach((b,k)=> b.classList.toggle('active', k===idx)); }
      function scrollThumb(center){
        const t = ths[idx]; if(!t) return;
        try{ t.scrollIntoView({behavior:'smooth', inline:(center?'center':'nearest'), block:'nearest'}); }
        catch(_){ t.scrollIntoView(); }
      }
      function show(i, opt){
        idx = (i + imgs.length) % imgs.length;
        main.src = imgs[idx];
        highlight();
        if(!opt || opt.scroll !== false) scrollThumb(true);
      }

      ths.forEach((btn,i)=> btn.addEventListener('click', ()=> show(i)));
      prev.addEventListener('click', ()=> show(idx-1));
      next.addEventListener('click', ()=> show(idx+1));

      // 터치 스와이프
      let startX=null;
      main.addEventListener('touchstart', e=>{ startX = e.touches[0].clientX; }, {passive:true});
      main.addEventListener('touchend', e=>{
        if(startX===null) return;
        const dx = e.changedTouches[0].clientX - startX;
        if(Math.abs(dx)>40) show(idx + (dx<0?1:-1));
        startX=null;
      }, {passive:true});

      // 초기 표시
      highlight();
      show(0, {scroll:false});
    }

    try{
      const imgs = await getImages();
      buildUI(imgs);
    }catch(err){
      console.error(err);
      strip.innerHTML = '<div class="empty">이미지 목록을 불러오지 못했음</div>';
      prev.style.display = next.style.display = 'none';
    }
  })();
  </script>
</body>
</html>
