<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>GIF Galleries (Perf tuned)</title>
<style>
  html,body{overscroll-behavior-y:none}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR','Malgun Gothic',Helvetica,Arial,sans-serif;margin:0}
  #amg{max-width:1000px;margin:24px auto;padding:16px}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;justify-content:center}
  .tab{border:1px solid #ddd;background:#fafafa;border-radius:999px;padding:8px 14px;cursor:pointer;user-select:none}
  .tab.active{background:#1d4ed8;color:#fff;border-color:#1d4ed8}
  .stage{position:relative;border:1px solid #eee;border-radius:12px;padding:12px;height:450px;display:flex;align-items:center;justify-content:center;text-align:center}
  #amg_main{max-width:100%;max-height:100%;width:auto;height:auto;display:inline-block;border-radius:8px;pointer-events:none;object-fit:contain}
  .nav{position:absolute;top:50%;transform:translateY(-50%);width:40px;height:40px;border-radius:999px;border:0;background:rgba(0,0,0,.45);color:#fff;font-size:20px;cursor:pointer;z-index:10;display:flex;align-items:center;justify-content:center}
  #amg_prev{left:8px} #amg_next{right:8px}
  #amg_strip{margin-top:10px;display:flex;gap:10px;overflow-x:auto;-webkit-overflow-scrolling:touch;padding:6px 2px;overscroll-behavior:contain;touch-action:pan-x;scrollbar-gutter:stable both-edges}
  .amg_th{flex:0 0 calc((100% - 7*10px)/8);border:2px solid #ddd;border-radius:8px;padding:0;background:#fff;cursor:pointer;outline:none}
  .amg_th img{display:block;width:100%;height:100px;object-fit:cover;border-radius:6px;pointer-events:none}
  .amg_th.active{border-color:#7aa7ff}
  .empty{color:#888;text-align:center;padding:20px 0}
  .more-wrap{display:flex;justify-content:center;margin:10px 0}
  .more{border:1px solid #ddd;background:#fafafa;border-radius:10px;padding:8px 14px;cursor:pointer}
</style>
</head>
<body>
<div id="amg">
  <div class="tabs" id="tabs"></div>

  <div class="stage">
    <img id="amg_main" alt="미리보기" fetchpriority="high" decoding="async">
    <button id="amg_prev" class="nav" type="button" aria-label="이전">‹</button>
    <button id="amg_next" class="nav" type="button" aria-label="다음">›</button>
  </div>
  <div id="amg_strip"></div>
  <div class="more-wrap"><button id="more" class="more" type="button">더 보기</button></div>
</div>

<script>
(() => {
  const GALLERIES = [
    { label:'A-1타입', dir:'A-1images' },
    { label:'A-2타입', dir:'A-2images' },
    { label:'B타입',   dir:'Bimages'   }
  ];
  const MAX_PER_DIR = 60;
  const BATCH = 12; // 한 번에 보여줄 썸네일 개수

  const tabsEl = document.getElementById('tabs');
  const main   = document.getElementById('amg_main');
  const prev   = document.getElementById('amg_prev');
  const next   = document.getElementById('amg_next');
  const strip  = document.getElementById('amg_strip');
  const moreBtn= document.getElementById('more');

  // HEAD 프로빙: 연속 3번 없으면 (일부라도 찾은 이후) 중단 → 탐색시간 단축
  async function loadImagesByProbe(dir, maxTry=MAX_PER_DIR){
    const out=[]; let misses=0;
    for(let i=1;i<=maxTry;i++){
      const p = `${dir}/${i}.gif`;
      try{
        const r = await fetch(p, { method:'HEAD' }); // cache는 기본값(prefer-cache)
        if(r.ok){ out.push(p); misses=0; }
        else { if(out.length) misses++; }
      }catch{ if(out.length) misses++; }
      if(out.length && misses>=3) break;
    }
    return out;
  }

  // Lazy thumbnails with IO + batch append
  const io = 'IntersectionObserver' in window ? new IntersectionObserver(entries => {
    for(const e of entries){
      if(e.isIntersecting){
        const img = e.target;
        if(img.dataset.src){
          // 스로틀링: requestIdleCallback / setTimeout으로 살짝 늦게 로드
          const loadFn = () => { img.src = img.dataset.src; img.removeAttribute('data-src'); };
          if('requestIdleCallback' in window){ requestIdleCallback(loadFn, {timeout:500}); }
          else { setTimeout(loadFn, 0); }
        }
        io.unobserve(img);
      }
    }
  }, { root: strip, rootMargin: '200px 0px', threshold: 0.01 }) : null;

  let imgs = [];       // 현재 탭 이미지 리스트
  let shown = 0;       // strip에 붙인 개수
  let ths = [];        // 썸네일 버튼 목록 (DOM)

  function appendBatch(){
    const end = Math.min(shown + BATCH, imgs.length);
    const ph  = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';
    for(let i=shown;i<end;i++){
      const src = imgs[i];
      const btn = document.createElement('button');
      btn.className = 'amg_th';
      btn.dataset.idx = i;

      const im = document.createElement('img');
      im.alt = `썸네일 ${i+1}`;
      im.loading = 'lazy'; im.decoding = 'async';
      im.dataset.src = src; // 보여질 때 로드
      im.src = ph;
      if(io) io.observe(im); else im.src = src;

      btn.appendChild(im);
      strip.appendChild(btn);
      ths.push(btn);
    }
    shown = end;
    moreBtn.style.display = shown < imgs.length ? '' : 'none';
  }

  // 메인 이미지 이웃만 살짝 프리로드 (폭주 방지)
  function preloadNeighbor(idx){
    [idx-1, idx+1].forEach(k=>{
      if(k<0 || k>=imgs.length) return;
      const url = imgs[k];
      const img = new Image();
      img.decoding = 'async';
      img.loading = 'eager';
      img.src = url;
    });
  }

  let idx = 0;
  function highlight(){ ths.forEach((el,k)=>el.classList.toggle('active', k===idx)); }
  function show(i){
    idx = (i + imgs.length) % imgs.length;
    const src = imgs[idx];
    if(main.src !== src) main.src = src;
    highlight();
    preloadNeighbor(idx);
    // strip 안에서 보이게
    try{ ths[idx]?.scrollIntoView({behavior:'smooth', inline:'center'}); }catch{}
  }

  function renderGallery(list){
    imgs = list; shown = 0; ths = [];
    strip.innerHTML = '';
    if(!imgs.length){
      strip.innerHTML = '<div class="empty">이미지 없음</div>';
      main.removeAttribute('src');
      prev.style.display = next.style.display = 'none';
      moreBtn.style.display = 'none';
      return;
    }
    prev.style.display = next.style.display = '';
    appendBatch();
    show(0);
  }

  prev.onclick = ()=> show(idx-1);
  next.onclick = ()=> show(idx+1);
  moreBtn.onclick = appendBatch;

  // 스와이프
  let startX=null;
  main.addEventListener('touchstart', e=>{ startX=e.touches[0].clientX; }, {passive:true});
  main.addEventListener('touchend', e=>{
    if(startX===null) return;
    const dx=e.changedTouches[0].clientX-startX;
    if(Math.abs(dx)>40) show(idx+(dx<0?1:-1));
    startX=null;
  }, {passive:true});

  async function activateTab(tab){
    tabsEl.querySelectorAll('.tab').forEach(el=>el.classList.remove('active'));
    tab.el.classList.add('active');
    const list = await loadImagesByProbe(tab.dir);
    renderGallery(list);
  }

  // 탭 버튼
  GALLERIES.forEach(g=>{
    const btn = document.createElement('div');
    btn.className='tab'; btn.textContent=g.label;
    btn.onclick = () => activateTab({...g, el:btn});
    g.el = btn; tabsEl.appendChild(btn);
  });

  // 첫 탭
  activateTab(GALLERIES[0]);
})();
</script>
</body>
</html>
