<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>GIF Galleries (iframe-safe, horizontal autoload)</title>
<style>
  html,body{overscroll-behavior-y:none}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR','Malgun Gothic',Helvetica,Arial,sans-serif;margin:0}
  #amg{max-width:1000px;margin:24px auto;padding:16px}
  .tabs{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;justify-content:center}
  .tab{border:1px solid #ddd;background:#fafafa;border-radius:999px;padding:8px 14px;cursor:pointer;user-select:none}
  .tab.active{background:#1d4ed8;color:#fff;border-color:#1d4ed8}
  .stage{position:relative;border:1px solid #eee;border-radius:12px;padding:12px;height:450px;display:flex;align-items:center;justify-content:center;text-align:center}
  #amg_main{max-width:100%;max-height:100%;width:auto;height:auto;display:inline-block;border-radius:8px;pointer-events:none;object-fit:contain}
  .nav{position:absolute;top:50%;transform:translateY(-50%);width:40px;height:40px;border-radius:999px;border:0;background:rgba(0,0,0,.45);color:#fff;font-size:20px;cursor:pointer;z-index:10;display:flex;align-items:center;justify-content:center}
  #amg_prev{left:8px} #amg_next{right:8px}
  #amg_strip{margin-top:10px;display:flex;gap:10px;overflow-x:auto;-webkit-overflow-scrolling:touch;padding:6px 2px;overscroll-behavior:contain;touch-action:pan-x;scrollbar-gutter:stable both-edges}
  .amg_th{flex:0 0 calc((100% - 7*10px)/8);border:2px solid #ddd;border-radius:8px;padding:0;background:#fff;cursor:pointer;outline:none}
  .amg_th img{display:block;width:100%;height:100px;object-fit:cover;border-radius:6px;pointer-events:none}
  .amg_th.active{border-color:#7aa7ff}
  .empty{color:#888;text-align:center;padding:20px 0}
  .sentinel{flex:0 0 1px; width:1px; height:1px}
</style>
</head>
<body>
<div id="amg">
  <div class="tabs" id="tabs"></div>

  <div class="stage">
    <img id="amg_main" alt="미리보기" fetchpriority="high" decoding="async">
    <button id="amg_prev" class="nav" type="button" aria-label="이전">‹</button>
    <button id="amg_next" class="nav" type="button" aria-label="다음">›</button>
  </div>

  <div id="amg_strip"></div>
</div>

<script>
(() => {
  // 탭/폴더
  const GALLERIES = [
    { label:'A-1타입', dir:'A-1images' },
    { label:'A-2타입', dir:'A-2images' },
    { label:'B타입',   dir:'Bimages'   }
  ];
  const MAX_PER_DIR = 60;
  const BATCH = 12; // 한 번에 추가하는 썸네일 수

  const tabsEl = document.getElementById('tabs');
  const main   = document.getElementById('amg_main');
  const prev   = document.getElementById('amg_prev');
  const next   = document.getElementById('amg_next');
  const strip  = document.getElementById('amg_strip');

  // 수평 센티넬 (strip 내부 끝에 둠)
  const sentinel = document.createElement('div');
  sentinel.id = 'sentinel';
  sentinel.className = 'sentinel';

  // HEAD 프로빙 (일부라도 찾은 뒤 연속 3번 없으면 중단)
  async function loadImagesByProbe(dir, maxTry=MAX_PER_DIR){
    const out=[]; let misses=0;
    for(let i=1;i<=maxTry;i++){
      const p = `${dir}/${i}.gif`;
      try{
        const r = await fetch(p, { method:'HEAD' });
        if(r.ok){ out.push(p); misses=0; }
        else { if(out.length) misses++; }
      }catch{ if(out.length) misses++; }
      if(out.length && misses>=3) break;
    }
    return out;
  }

  // Lazy thumbnails: strip을 root로 사용
  const thumbIO = 'IntersectionObserver' in window ? new IntersectionObserver(entries => {
    for(const e of entries){
      if(e.isIntersecting){
        const img = e.target;
        if(img.dataset.src){
          const loadFn = () => { img.src = img.dataset.src; img.removeAttribute('data-src'); };
          if('requestIdleCallback' in window){ requestIdleCallback(loadFn, {timeout:500}); }
          else { setTimeout(loadFn, 0); }
        }
        thumbIO.unobserve(img);
      }
    }
  }, { root: strip, rootMargin: '200px 0px', threshold: 0.01 }) : null;

  // strip 끝 감지: 가로 스크롤 기반 오토로드
  let isLoading = false;
  const sentinelIO = 'IntersectionObserver' in window ? new IntersectionObserver(entries => {
    for(const e of entries){
      if(e.isIntersecting) appendBatch();
    }
  }, { root: strip, rootMargin: '100px', threshold: 0.0 }) : null;

  let imgs = [];
  let shown = 0;
  let ths = [];
  let idx = 0;

  function ensureThumbVisible(k){
    const t = ths[k];
    if(!t) return;
    const tRect = t.getBoundingClientRect();
    const sRect = strip.getBoundingClientRect();
    if(tRect.left < sRect.left){
      strip.scrollLeft += (tRect.left - sRect.left) - 10;
    }
    if(tRect.right > sRect.right){
      strip.scrollLeft += (tRect.right - sRect.right) + 10;
    }
  }

  function preloadNeighbor(k){
    [k-1, k+1].forEach(n=>{
      if(n<0 || n>=imgs.length) return;
      const url = imgs[n];
      const im = new Image();
      im.decoding = 'async';
      im.loading = 'eager';
      im.src = url;
    });
  }

  function highlight(){ ths.forEach((el,k)=>el.classList.toggle('active', k===idx)); }

  function show(i){
    if(!imgs.length) return;
    idx = (i + imgs.length) % imgs.length;
    const src = imgs[idx];
    if(main.src !== src) main.src = src;
    highlight();
    preloadNeighbor(idx);
    ensureThumbVisible(idx); // 부모 페이지 스크롤 방지: 수평만 살짝 이동
  }

  function appendBatch(){
    if(isLoading || shown >= imgs.length) return;
    isLoading = true;

    const end = Math.min(shown + BATCH, imgs.length);
    const ph  = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==';
    const frag = document.createDocumentFragment();

    for(let i=shown;i<end;i++){
      const src = imgs[i];
      const btn = document.createElement('button');
      btn.className = 'amg_th';
      btn.dataset.idx = i;
      btn.type = 'button';
      btn.addEventListener('mousedown', e => e.preventDefault()); // 포커스 점프로 부모 스크롤 방지
      btn.onclick = () => show(i);

      const im = document.createElement('img');
      im.alt = `썸네일 ${i+1}`;
      im.loading = 'lazy'; im.decoding = 'async';
      im.dataset.src = src;
      im.src = ph;
      if(thumbIO) thumbIO.observe(im); else im.src = src;

      btn.appendChild(im);
      frag.appendChild(btn);
      ths.push(btn);
    }

    strip.appendChild(frag);
    shown = end;

    // 항상 strip 끝으로 센티넬 이동 후 관찰
    strip.appendChild(sentinel);
    if(sentinelIO){
      sentinelIO.unobserve(sentinel);
      sentinelIO.observe(sentinel);
    }

    isLoading = false;
  }

  function renderGallery(list){
    imgs = list; shown = 0; ths = []; idx = 0;
    strip.innerHTML = '';
    if(!imgs.length){
      strip.innerHTML = '<div class="empty">이미지 없음</div>';
      main.removeAttribute('src');
      prev.style.display = next.style.display = 'none';
      return;
    }
    prev.style.display = next.style.display = '';
    appendBatch();     // 초기 배치
    show(0);
  }

  prev.onclick = ()=> show(idx-1);
  next.onclick = ()=> show(idx+1);

  // 가로 스크롤 폴백: 끝 근처면 자동 추가
  strip.addEventListener('scroll', () => {
    if(shown >= imgs.length || isLoading) return;
    const nearEnd = strip.scrollLeft + strip.clientWidth >= strip.scrollWidth - 80;
    if(nearEnd) appendBatch();
  }, { passive:true });

  // 스와이프
  let startX=null;
  main.addEventListener('touchstart', e=>{ startX=e.touches[0].clientX; }, {passive:true});
  main.addEventListener('touchend', e=>{
    if(startX===null) return;
    const dx=e.changedTouches[0].clientX-startX;
    if(Math.abs(dx)>40) show(idx+(dx<0?1:-1));
    startX=null;
  }, {passive:true});

  async function activateTab(tab){
    tabsEl.querySelectorAll('.tab').forEach(el=>el.classList.remove('active'));
    tab.el.classList.add('active');
    const list = await loadImagesByProbe(tab.dir);
    renderGallery(list);
  }

  // 탭 버튼
  GALLERIES.forEach(g=>{
    const btn = document.createElement('div');
    btn.className='tab'; btn.textContent=g.label;
    btn.onclick = () => activateTab({...g, el:btn});
    g.el = btn; tabsEl.appendChild(btn);
  });

  // 첫 탭
  activateTab(GALLERIES[0]);
})();
</script>
</body>
</html>
